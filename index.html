<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Python Runner</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --accent-color: #28a745;
            --accent-hover: #218838;
            --code-bg: #ffffff;
            --output-bg: #1e1e1e;
            --output-text: #f0f0f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode {
            --bg-color: #0d1117;
            --container-bg: #161b22;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #238636;
            --accent-hover: #2ea043;
            --code-bg: #0d1117;
            --output-bg: #0d1117;
            --output-text: #c9d1d9;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        /* Global Reset for layout sanity */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            width: 100%;
            min-height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            width: 100%;
            max-width: 900px; /* Centered compact view on desktop */
            margin: 0 auto;
            background: var(--container-bg);
            border: none;
            border-radius: 0;
            box-shadow: none;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100%;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        h3 { 
            margin: 0; 
            font-weight: 600; 
            font-size: 16px;
        }

        .controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
        }

        .instructions {
            background: var(--bg-color);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
            font-size: 13px;
            line-height: 1.4;
        }

        .editor-container {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        textarea {
            width: 100%;
            height: 160px;
            padding: 12px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            border: none;
            background: var(--code-bg);
            color: var(--text-color);
            resize: vertical;
            outline: none;
            box-sizing: border-box;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-color);
            border-top: 1px solid var(--border-color);
        }

        .status {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-color);
            opacity: 0.8;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button.run-btn {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: transform 0.1s, background-color 0.2s;
        }

        button.run-btn:hover { background: var(--accent-hover); }
        button.run-btn:active { transform: scale(0.98); }

        /* Button Group & Verify Button */
        .btn-group {
            display: flex;
            gap: 8px;
        }

        button.verify-btn {
            background: transparent;
            color: var(--accent-color);
            border: 1px solid var(--accent-color);
            padding: 6px 16px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button.verify-btn:hover {
            background: rgba(40, 167, 69, 0.1);
        }
        button.verify-btn:active { transform: scale(0.98); }

        #output {
            background: var(--output-bg);
            color: var(--output-text);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Menlo', 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            min-height: 60px;
            white-space: pre-wrap;
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        /* Utility classes for verification status */
        .status-success { color: #2ea043 !important; }
        .status-error { color: #cb2431 !important; }
        .theme-toggle {
            background: none;
            border: 1px solid var(--border-color);
            color: var(--text-color);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
    </style>
</head>
<body class="dark-mode">

    <div class="app-container">
        <div class="header">
            <h3>Interactive Python Runner</h3>
            <div class="controls">
                <select id="exerciseSelect" onchange="loadExercise()">
                    <option value="version">1. Verify Setup</option>
                    <option value="functions">2. Functions</option>
                    <option value="types">3. Type Hints</option>
                    <option value="control">4. Control Flow</option>
                    <option value="custom">Playground</option>
                </select>
                <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
            </div>
        </div>

        <div id="instructions" class="instructions">Select an exercise to begin.</div>

        <div class="editor-container">
            <textarea id="code" spellcheck="false"></textarea>
            <div class="toolbar">
                <span class="status" id="status">Ready to Run</span>
                <div class="btn-group">
                    <button class="run-btn" onclick="runCode()">Run ‚ñ∂</button>
                    <button class="verify-btn" onclick="verifyCode()">Verify ‚úÖ</button>
                </div>
            </div>
        </div>

        <pre id="output">Output will appear here...</pre>
    </div>

    <script>
        // CONFIGURATION
        const API_URL = "https://simple-judge0-backend-production.up.railway.app";

        // Enable Tab Indentation & Shortcuts
        document.getElementById('code').addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 4;
            }
            if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                e.preventDefault();
                if (e.shiftKey) verifyCode();
                else runCode();
            }
        });

        // Disable Paste & Drag-and-Drop
        function blockInput(e) {
            e.preventDefault();
            const statusEl = document.getElementById('status');
            statusEl.innerText = "‚ö†Ô∏è Copy/Paste disabled (Type it out!)";
            statusEl.style.color = "#cb2431";
            setTimeout(() => {
                statusEl.innerText = "Ready to Run";
                statusEl.style.color = "";
            }, 2000);
        }
        const editor = document.getElementById('code');
        editor.addEventListener('paste', blockInput);
        editor.addEventListener('drop', blockInput);

        function toggleTheme() { document.body.classList.toggle('dark-mode'); }
        function initTheme() {
            if (new URLSearchParams(window.location.search).get('theme') === 'light') {
                document.body.classList.remove('dark-mode');
            }
        }
        initTheme();

        // EXERCISES
        const exercisesPython = {
            version: {
                desc: "Task: Check Python version. (Should be 3.11)",
                code: "import sys\nprint(f\"Python Version: {sys.version.split()[0]}\")",
                testFile: "tests/version.py"
            },
            functions: {
                desc: "Task: Implement 'is_empty(val)' to return True for None or empty strings.",
                code: "def is_empty(val):\n    # TODO: Implement logic here\n    if val is None:\n        return True\n    return False",
                testFile: "tests/functions.py"
            },
            types: {
                desc: "Task: Add type hints to 'process_items'.",
                code: "from typing import List, Callable, Any\n\ndef process_items(items, transformer):\n    return [transformer(i) for i in items]\n\n# Test helper\ndef double(x: int) -> int: return x * 2",
                testFile: "tests/types.py"
            },
            control: {
                desc: "Task: Modify loop. 1) Skip negatives. 2) Break if > 50. Append valid nums to 'result'.",
                code: "numbers = [10, -5, 20, 60, 30]\nresult = []\n\nfor n in numbers:\n    # TODO: Implement logic\n    print(n)\n    result.append(n)",
                testFile: "tests/control.py"
            },
            custom: {
                desc: "Playground",
                code: "print('Hello Python!')",
                testFile: "tests/custom.py"
            }
        };

        const exercisesJS = {
            variables: {
                desc: "Task: 1. Set 'firstName' to 'Alice'. 2. Set 'minutes' to 10 and 'seconds' to minutes * 60.",
                code: "// TODO: Declare variable 'firstName' with value 'Alice'\n\n// TODO: Calculate seconds\nlet minutes = 5;\nlet seconds = 0;",
                testFile: "tests/js_variables.js"
            },
            conditionals: {
                desc: "Task: Implement 'checkGrade(score)'. Return 'Passed' if >= 60, else 'Failed'.",
                code: "function checkGrade(score) {\n    // TODO: Write if/else logic\n    return 'Failed';\n}",
                testFile: "tests/js_conditionals.js"
            },
            demo: {
                desc: "Task: Write a function 'sum(a, b)' that returns the sum.",
                code: "function sum(a, b) {\n    // TODO: Implement\n    return 0;\n}",
                testFile: "tests/js_demo.js"
            },
            custom: {
                desc: "Playground",
                code: "console.log('Hello JavaScript!');",
                testFile: "tests/js_demo.js" // Reuse for now
            }
        };

        let currentLang = 'python';
        let exercises = exercisesPython;

        function loadExercise() {
            const key = document.getElementById('exerciseSelect').value;
            if (!exercises[key]) return; 
            const ex = exercises[key];
            
            document.getElementById('instructions').innerText = ex.desc;
            document.getElementById('code').value = ex.code;
            document.getElementById('status').innerText = 'Ready to Run';
            document.getElementById('status').className = 'status';
            document.getElementById('output').innerText = 'Output will appear here...';
            
            const newUrl = new URL(window.location);
            newUrl.searchParams.set('exercise', key);
            window.history.replaceState({}, '', newUrl);
        }

        function initApp() {
            const params = new URLSearchParams(window.location.search);
            
            // Detect Language
            if (params.get('lang') === 'javascript' || params.get('lang') === 'js') {
                currentLang = 'javascript';
                exercises = exercisesJS;
                document.title = "Interactive JavaScript Runner";
                document.querySelector('h3').innerText = "Interactive JavaScript Runner";
            }

            // Populate Select
            const select = document.getElementById('exerciseSelect');
            select.innerHTML = '';
            for (const [key, val] of Object.entries(exercises)) {
                const opt = document.createElement('option');
                opt.value = key;
                opt.innerText = val.desc.substring(0, 40) + (val.desc.length > 40 ? '...' : ''); // Truncate for display
                select.appendChild(opt);
            }

            const exParam = params.get('exercise') || params.get('ex');
            if (exParam && exercises[exParam]) {
                select.value = exParam;
            }
            loadExercise();
        }
        initApp();

        async function execute(mode) {
            let code = document.getElementById('code').value;
            const outputEl = document.getElementById('output');
            const statusEl = document.getElementById('status');
            const exKey = document.getElementById('exerciseSelect').value;
            
            statusEl.innerHTML = mode === 'verify' ? '‚è≥ Verifying...' : '‚è≥ Running...';
            statusEl.className = 'status';
            outputEl.textContent = 'Executing...';

            // If VERIFY mode, fetch and append the test code
            if (mode === 'verify') {
                try {
                    const testUrl = exercises[exKey].testFile;
                    const testResp = await fetch(testUrl);
                    if (!testResp.ok) throw new Error(`Failed to load tests: ${testUrl}`);
                    const testCode = await testResp.text();
                    
                    code += "\n\n/* --- VERIFICATION TESTS --- */\n" + testCode;
                } catch (e) {
                    console.error("Test Load Error:", e);
                    statusEl.innerText = "‚ùå Failed to load validation tests";
                    return;
                }
            }

            const payload = {
                source_code: code,
                language_id: currentLang === 'javascript' ? 63 : 92,
                stdin: ""
            };

            try {
                const response = await fetch(`${API_URL}/submissions?base64_encoded=false&wait=true`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);

                const result = await response.json();
                let output = (result.stdout || "") + (result.stderr || "") + (result.compile_output || "");
                output = output.trim() || "No output";

                // Clean up the output display
                if (mode === 'verify') {
                    if (output.includes("‚úÖ_PASS_‚úÖ")) {
                        statusEl.innerHTML = '<span class="status-success">‚úÖ Verification Passed!</span>';
                        output = output.replace("‚úÖ_PASS_‚úÖ", "").trim();
                    } else if (output.includes("‚ùå_FAIL:")) {
                        const match = output.match(/‚ùå_FAIL: (.*)/);
                        const err = match ? match[1] : "Check logic";
                        statusEl.innerHTML = `<span class="status-error">‚ùå ${err}</span>`;
                    } else {
                        statusEl.innerHTML = '<span class="status-error">‚ùå Execution/Syntax Error</span>';
                    }
                } else {
                    statusEl.innerText = "Execution Complete";
                }
                
                outputEl.textContent = output;

            } catch (err) {
                console.error(err);
                outputEl.textContent = `Connection failure.\n${err.message}`;
                statusEl.innerHTML = '<span class="status-error">Connection Error</span>';
            }
        }

        function runCode() { execute('run'); }
        function verifyCode() { execute('verify'); }
    </script>
</body>
</html>
