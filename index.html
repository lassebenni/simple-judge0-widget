<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Runner</title>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --container-bg: #ffffff;
            --text-color: #333333;
            --border-color: #e1e4e8;
            --accent-color: #28a745;
            --accent-hover: #218838;
            --code-bg: #ffffff;
            --output-bg: #1e1e1e;
            --output-text: #f0f0f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body.dark-mode {
            --bg-color: #0d1117;
            --container-bg: #161b22;
            --text-color: #c9d1d9;
            --border-color: #30363d;
            --accent-color: #238636;
            --accent-hover: #2ea043;
            --code-bg: #0d1117;
            --output-bg: #0d1117;
            --output-text: #c9d1d9;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
        }

        *, *::before, *::after { box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s, color 0.3s;
        }

        .app-container {
            width: 100%;
            max-width: 1000px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 100vh;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        h3 { margin: 0; font-weight: 600; font-size: 16px; }

        .controls { display: flex; gap: 8px; align-items: center; }

        select {
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background: var(--bg-color);
            color: var(--text-color);
            font-size: 13px;
            cursor: pointer;
        }

        .instructions {
            background: var(--bg-color);
            padding: 8px 12px;
            border-radius: 6px;
            border-left: 3px solid var(--accent-color);
            font-size: 13px;
            line-height: 1.4;
        }

        /* PROJECT UI STYLES */
        .project-layout {
            display: none;
            grid-template-columns: 180px 1fr;
            height: 450px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .file-tree {
            background: rgba(0, 0, 0, 0.05);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 10px 0;
        }

        body.dark-mode .file-tree { background: rgba(0, 0, 0, 0.3); }

        .file-item {
            padding: 6px 15px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 6px;
            opacity: 0.7;
        }

        .file-item:hover { background: rgba(0, 0, 0, 0.05); opacity: 1; }
        .file-item.active {
            background: rgba(0, 120, 215, 0.1);
            color: #0078d7;
            opacity: 1;
            font-weight: 600;
        }

        .editor-area {
            display: flex;
            flex-direction: column;
            height: 100%;
            background: var(--code-bg);
        }

        .tab-bar {
            display: flex;
            background: rgba(0, 0, 0, 0.02);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }

        body.dark-mode .tab-bar { background: rgba(0, 0, 0, 0.2); }

        .tab {
            padding: 8px 15px;
            font-size: 11px;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            color: var(--text-color);
            opacity: 0.6;
            white-space: nowrap;
        }

        .tab.active {
            background: var(--code-bg);
            opacity: 1;
            border-bottom: 2px solid var(--accent-color);
        }

        #code {
            flex: 1;
            width: 100%;
            padding: 12px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 13px;
            border: none;
            background: transparent;
            color: var(--text-color);
            resize: none;
            outline: none;
        }

        /* SIMPLE UI STYLES */
        .simple-editor { margin-bottom: 0; }
        #code-simple { 
            width: 100%;
            height: 400px; 
            border-radius: 6px; 
            border: 1px solid var(--border-color); 
            padding: 12px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 13px;
            background: var(--code-bg);
            color: var(--text-color);
            resize: vertical;
            outline: none;
        }

        .toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }

        .status { font-size: 12px; font-weight: 500; }
        .status-success { color: #2ea043 !important; }
        .status-error { color: #cb2431 !important; }

        .btn-group { display: flex; gap: 8px; }

        button.run-btn, button.verify-btn {
            padding: 6px 16px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }

        button.run-btn { background: var(--accent-color); color: white; border: none; }
        button.run-btn:hover { background: var(--accent-hover); }

        button.verify-btn { background: transparent; color: var(--accent-color); border: 1px solid var(--accent-color); }
        button.verify-btn:hover { background: rgba(40, 167, 69, 0.1); }

        #output {
            background: var(--output-bg);
            color: var(--output-text);
            padding: 12px;
            border-radius: 6px;
            font-family: 'Menlo', 'Monaco', monospace;
            font-size: 12px;
            min-height: 80px;
            white-space: pre-wrap;
            border: 1px solid var(--border-color);
            overflow-x: auto;
        }

        .theme-toggle { background: none; border: 1px solid var(--border-color); color: var(--text-color); padding: 4px 8px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body class="dark-mode">
    <div class="app-container">
        <div class="header">
            <h3 id="appTitle">Interactive Runner</h3>
            <div class="controls">
                <select id="exerciseSelect" onchange="loadExercise()">
                    <!-- Options injected by JS -->
                </select>
                <button class="theme-toggle" onclick="toggleTheme()">üåó</button>
            </div>
        </div>

        <div id="instructions" class="instructions">Select an exercise to begin.</div>

        <!-- Project Layout -->
        <div class="project-layout" id="projectLayout">
            <div class="file-tree" id="fileTree"></div>
            <div class="editor-area">
                <div class="tab-bar" id="tabBar"></div>
                <textarea id="code" spellcheck="false"></textarea>
            </div>
        </div>

        <!-- Simple Layout -->
        <div class="simple-editor" id="simpleLayout">
            <textarea id="code-simple" spellcheck="false"></textarea>
        </div>

        <div class="toolbar">
            <span class="status" id="status">Ready</span>
            <div class="btn-group">
                <button class="run-btn" id="runBtn" onclick="runCode()">Run ‚ñ∂</button>
                <button class="verify-btn" id="verifyBtn" onclick="verifyCode()">Verify ‚úÖ</button>
            </div>
        </div>

        <pre id="output">Output will appear here...</pre>
    </div>

    <script>
        const API_URL = "https://simple-judge0-backend-production.up.railway.app";
        
        // State
        let exercises = {};
        let currentLang = 'python';
        let isProjectView = false;
        let projectFiles = {}; // { name: { content: "" } }
        let activeFileKey = '';

        // UI Helpers
        function toggleTheme() { document.body.classList.toggle('dark-mode'); }

        // Keyboard & Input
        function setupEditorEvents(el) {
            el.addEventListener('keydown', function(e) {
                if (e.key === 'Tab') {
                    e.preventDefault();
                    const start = this.selectionStart;
                    const end = this.selectionEnd;
                    this.value = this.value.substring(0, start) + "    " + this.value.substring(end);
                    this.selectionStart = this.selectionEnd = start + 4;
                }
                if ((e.metaKey || e.ctrlKey) && e.key === 'Enter') {
                    e.preventDefault();
                    if (e.shiftKey) verifyCode(); else runCode();
                }
            });
            el.addEventListener('paste', blockInput);
            el.addEventListener('drop', blockInput);
        }

        function blockInput(e) {
            e.preventDefault();
            const statusEl = document.getElementById('status');
            const oldText = statusEl.innerText;
            statusEl.innerText = "‚ö†Ô∏è Paste disabled";
            statusEl.classList.add('status-error');
            setTimeout(() => { statusEl.innerText = oldText; statusEl.classList.remove('status-error'); }, 1500);
        }

        setupEditorEvents(document.getElementById('code'));
        setupEditorEvents(document.getElementById('code-simple'));

        // Project Logic
        function syncState() {
            if (isProjectView && activeFileKey) {
                projectFiles[activeFileKey].content = document.getElementById('code').value;
            }
        }

        function switchFile(key) {
            syncState();
            activeFileKey = key;
            document.getElementById('code').value = projectFiles[key].content;
            renderProjectUI();
        }

        function renderProjectUI() {
            const tree = document.getElementById('fileTree');
            const tabs = document.getElementById('tabBar');
            tree.innerHTML = '';
            tabs.innerHTML = '';

            Object.entries(projectFiles).forEach(([name, file]) => {
                const item = document.createElement('div');
                item.className = `file-item ${name === activeFileKey ? 'active' : ''}`;
                item.innerHTML = `<span>üìÑ</span> ${name}`;
                item.onclick = () => switchFile(name);
                tree.appendChild(item);

                const tab = document.createElement('div');
                tab.className = `tab ${name === activeFileKey ? 'active' : ''}`;
                tab.innerText = name;
                tab.onclick = () => switchFile(name);
                tabs.appendChild(tab);
            });
        }

        function loadExercise() {
            syncState();
            const key = document.getElementById('exerciseSelect').value;
            const ex = exercises[key];
            if (!ex) return;

            document.getElementById('instructions').innerText = ex.desc;
            
            if (isProjectView) {
                if (ex.files) {
                    projectFiles = JSON.parse(JSON.stringify(ex.files));
                } else {
                    // Wrap simple exercise as a project file
                    const fileName = currentLang === 'javascript' ? 'main.js' : 'main.py';
                    projectFiles = { [fileName]: { content: ex.code || "" } };
                }
                activeFileKey = ex.entry_point || Object.keys(projectFiles)[0];
                document.getElementById('code').value = projectFiles[activeFileKey].content;
                renderProjectUI();
            } else {
                document.getElementById('code-simple').value = ex.code || "";
            }

            document.getElementById('status').innerText = 'Ready';
            document.getElementById('status').classList.remove('status-error', 'status-success');
            document.getElementById('output').innerText = 'Output will appear here...';
            
            const url = new URL(window.location);
            url.searchParams.set('exercise', key);
            window.history.replaceState({}, '', url);
        }

        async function initApp() {
            const params = new URLSearchParams(window.location.search);
            isProjectView = params.get('view') === 'project';
            
            document.getElementById('projectLayout').style.display = isProjectView ? 'grid' : 'none';
            document.getElementById('simpleLayout').style.display = isProjectView ? 'none' : 'block';

            try {
                const resp = await fetch('exercises.json');
                const config = await resp.json();
                
                if (params.get('lang') === 'js' || params.get('lang') === 'javascript') {
                    currentLang = 'javascript';
                    exercises = config.javascript;
                } else {
                    currentLang = 'python';
                    exercises = config.python;
                }

                document.getElementById('appTitle').innerText = currentLang === 'javascript' ? "Interactive JavaScript Runner" : "Interactive Python Runner";
                document.title = document.getElementById('appTitle').innerText;

                const select = document.getElementById('exerciseSelect');
                select.innerHTML = '';
                Object.entries(exercises).forEach(([key, ex], idx) => {
                    const opt = document.createElement('option');
                    opt.value = key;
                    opt.innerText = `${idx + 1}. ${ex.name || key}`;
                    select.appendChild(opt);
                });

                const exParam = params.get('exercise');
                if (exParam && exercises[exParam]) select.value = exParam;
                
                loadExercise();
            } catch (e) {
                console.error(e);
                document.getElementById('instructions').innerText = "Error loading exercises.";
            }

            if (params.get('theme') === 'light') {
                document.body.classList.remove('dark-mode');
            }
        }

        async function execute(mode) {
            syncState();
            const statusEl = document.getElementById('status');
            const outputEl = document.getElementById('output');
            const exKey = document.getElementById('exerciseSelect').value;
            const ex = exercises[exKey];

            statusEl.innerText = mode === 'verify' ? '‚è≥ Verifying...' : '‚è≥ Running...';
            statusEl.classList.remove('status-error', 'status-success');
            outputEl.innerText = 'Executing...';

            let payload = {
                language_id: currentLang === 'javascript' ? 63 : 92,
            };

            if (isProjectView) {
                payload.files = Object.entries(projectFiles).map(([name, f]) => ({ name, content: f.content }));
                payload.entry_point = ex.entry_point || (currentLang === 'javascript' ? "main.js" : "main.py");
            } else {
                payload.source_code = document.getElementById('code-simple').value;
            }

            // Append tests if verifying
            if (mode === 'verify') {
                try {
                    const testResp = await fetch(ex.testFile);
                    if (!testResp.ok) throw new Error("Test file not found");
                    const testCode = await testResp.text();
                    
                    if (isProjectView) {
                        const testFileName = "_test_script" + (currentLang === 'javascript' ? '.js' : '.py');
                        payload.files.push({ name: testFileName, content: testCode });
                        payload.entry_point = testFileName;
                    } else {
                        payload.source_code += (currentLang === 'javascript' ? "\n\n/* TEST */\n" : "\n\n# TEST\n") + testCode;
                    }
                } catch (e) {
                    statusEl.innerText = "‚ùå Test Load Fail";
                    statusEl.classList.add('status-error');
                    return;
                }
            }

            try {
                const resp = await fetch(`${API_URL}/submissions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await resp.json();
                let output = (result.stdout || "") + (result.stderr || "");
                output = output.trim() || "No output";

                if (mode === 'verify') {
                    if (output.includes("‚úÖ_PASS_‚úÖ")) {
                        statusEl.innerHTML = '<span class="status-success">‚úÖ Passed!</span>';
                        output = output.replace("‚úÖ_PASS_‚úÖ", "").trim();
                    } else if (output.includes("‚ùå_FAIL:")) {
                        const m = output.match(/‚ùå_FAIL: (.*)/);
                        statusEl.innerHTML = `<span class="status-error">‚ùå ${m ? m[1] : 'Fail'}</span>`;
                    } else {
                        statusEl.innerHTML = '<span class="status-error">‚ùå Error</span>';
                    }
                } else {
                    statusEl.innerText = "Done";
                }
                outputEl.innerText = output;
            } catch (e) {
                statusEl.innerText = "Connection Error";
                statusEl.classList.add('status-error');
            }
        }

        function runCode() { execute('run'); }
        function verifyCode() { execute('verify'); }

        initApp();
    </script>
</body>
</html>
